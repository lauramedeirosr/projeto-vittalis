<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="pt-br">
<head>
    <link rel="icon" type="imagem/png" th:href="@{/img/sub-logo1.png}">
    <link rel="stylesheet" th:href="@{/css/cadastro.css}"/>
    <link rel="stylesheet" th:href="@{/css/upload-imagens.css}"/>
    <th:block th:replace="fragments/config :: config"></th:block>
    <title>Formul√°rio de Altera√ß√£o de Pacotes</title>
</head>

<body>

<div th:replace="fragments/header :: header"></div>
<main>
    <h2 class="formulario d-flex justify-content-center mb-4">Formul√°rio de Altera√ß√£o de Pacotes</h2>
    <br>
    <div class="container mx-auto d-block">
        <form class="registration-form" th:action="@{/pacote/atualizar}" th:object="${pacote}" method="post" enctype="multipart/form-data" novalidate>
            <input type="hidden" th:field="*{id}"/>

            <!-- Nome Completo -->
            <div class="form-group row mb-4">
                <h3 class="dados">Dados do Pacote</h3>
                <br>
                <div class="col-sm-12">
                    <small class="nomeInput form-text text-muted d-block mt-1">Nome do Destino</small>
                    <input type="text" th:field="*{nomeDestino}" class="form-control" id="nomeDestino"
                           name="nomeDestino" placeholder="EX.: S√£o Paulo para Maldivas" required>
                </div>
            </div>

            <div class="form-group row mb-4">
                <div class="col-sm-12">
                    <small class="nomeInput form-text text-muted d-block mt-1">Pre√ßo</small>
                    <input type="text" th:field="*{preco}" class="form-control" id="preco" name="preco"
                           placeholder="$" required/>
                </div>
            </div>

            <!-- Descri√ß√£o do Pacote -->
            <div class="form-group row mb-4">
                <div class="col-sm-12">
                    <small class=" nomeInput form-text text-muted d-block mt-1">Descri√ß√£o do Pacote</small>
                    <textarea th:field="*{descricao}" id="descricao" name="descricao" rows="2" cols="148" placeholder="Descri√ß√£o..."></textarea>
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-6 mb-2 mb-md-0">
                    <small class=" nomeInput form-text text-muted d-block mt-1">Data limite da inscri√ß√£o</small>
                    <input type="date" th:field="*{dataLimiteInscricao}" class="form-control" id="data_limite" placeholder="dd/mm/aaaa" required/>
                </div>

                <div class="col-md-6">
                    <small class=" nomeInput form-text text-muted d-block mt-1">Data da Expedi√ß√£o</small>
                    <input type="date" th:field="*{dataExpedicao}" class="form-control" id="dataExpedicao" placeholder="dd/mm/aaaa" required/>
                </div>
            </div>
            <br>

            <!-- Imagens Existentes -->
            <div class="row mb-4" th:if="${imagens != null and !imagens.isEmpty()}">
                <div class="col-md-12">
                    <h5>Imagens Atuais do Pacote:</h5>
                    <div id="existingImagesList" class="d-flex flex-wrap gap-3">
                        <div th:each="imagem : ${imagens}" class="existing-image-item" th:data-id="${imagem.id}">
                            <img th:src="@{${imagem.caminhoImagem}}" class="existing-preview-image" 
                                 th:class="${imagem.destaque} ? 'existing-preview-image destaque' : 'existing-preview-image'">
                            <div class="destaque-badge" th:class="${imagem.destaque} ? 'show' : ''">DESTAQUE</div>
                            <div class="image-name" th:text="${imagem.nomeArquivo}">Nome da imagem</div>
                            <button type="button" class="remove-existing-btn" th:data-id="${imagem.id}">√ó</button>
                        </div>
                    </div>
                    <small class="form-text text-muted mt-2">Clique em uma imagem para marc√°-la como destaque ou no √ó para remov√™-la</small>
                </div>
            </div>

            <!-- Upload de Novas Imagens -->
            <div class="row mb-2">
                <div class="col-md-12 mb-2 mb-md-0">
                    <small class="nomeInput form-text text-muted d-block mt-1">Adicionar Novas Imagens</small>
                    <div class="image-upload-container">
                        <div class="upload-icon">üì∑</div>
                        <label for="imagensPacote" class="custom-file-upload">
                            Selecionar Imagens
                            <input type="file" id="imagensPacote" name="imagensPacote" multiple accept="image/*"/>
                        </label>
                        <div class="upload-instructions">
                            Arraste e solte as imagens aqui ou clique para selecionar<br>
                            <small>Formatos aceitos: JPG, PNG, GIF</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview das novas imagens selecionadas -->
            <div class="row mb-4" id="previewContainer" style="display: none;">
                <div class="col-md-12">
                    <h5>Novas Imagens Selecionadas:</h5>
                    <div id="imagePreviewList" class="d-flex flex-wrap gap-3">
                        <!-- As imagens ser√£o inseridas aqui via JavaScript -->
                    </div>
                    <small class="form-text text-muted mt-2">Clique em uma imagem para marc√°-la como destaque</small>
                </div>
            </div>

            <br>
            <!-- Navios -->
            <h3 class="dados">Escolha do Navio</h3>
                <br>
            <div class="row mb-2">
                <div class="col-md-6 mb-2 mb-md-0">
                    <div class="row mb-2">
                        <div class="col-md-6 mb-2 mb-md-0">
                            <small class="nomeInput form-text text-muted d-block mt-1">Navios</small>
                            <select class="navios" name="lista_navio" th:field="*{navio.id}">
                                <option value="">Selecione o Navio</option>
                                <option
                                        th:each="navio: ${navios}"
                                        th:value="${navio.id}"
                                        th:text="${navio.nomeNavio}"
                                        th:selected="${navio.id == pacote.navio?.id}"
                                ></option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <small class="nomeInput form-text text-muted d-block mt-1">Vagas dispon√≠veis</small>
                            <input type="text" placeholder="0" class="form-control" th:field="*{vagasDisponiveis}" required>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="row mb-3">
                    <div class="form-check form-switch">
                        <input class="checkbox" type="checkbox" value="" id="check1" switch>
                        <label class="form-check-label" for="check1">
                            Festas
                        </label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="checkbox" type="checkbox" value="" id="check2" switch>
                        <label class="form-check-label" for="check2">
                            Internet
                        </label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="checkbox" type="checkbox" value="" id="check3" switch>
                        <label class="form-check-label" for="check3">
                            Piscina
                        </label>
                    </div>
                    </div>
                    <div class= "row mb-3">
                    <div class="form-check form-switch">
                        <input class="checkbox" type="checkbox" value="" id="check4" switch>
                        <label class="form-check-label" for="check4">
                            Academia
                        </label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="checkbox" type="checkbox" value="" id="check5" switch>
                        <label class="form-check-label" for="check4">
                            Spa
                        </label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="checkbox" type="checkbox" value="" id="check6" switch>
                        <label class="form-check-label" for="check4">
                            Sauna
                        </label>
                    </div>
                    </div>
                </div>
            </div>

            <div class="form-group row mb-4">
                <div class="form-group row mt-4 col-sm-12">
                    <div class="divBotoes col-sm-12 d-flex justify-content-center">
                        <div class="text-center">
                            <button type="submit" class="botaoCadastrar">Salvar</button>
                        </div>
                        <div class="text-center">
                            <button type="reset" class="botaoCadastrar">Limpar</button>
                        </div>
                        <div class="text-center">
                            <button type="button" class="botaoCadastrar" onclick="window.location.href='/pacote'">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</main>

<div th:replace="fragments/footer :: footer"></div>

<!-- Adicione este script no final do body -->
<div th:replace="fragments/scripts :: scripts"></div>

<script>
$(document).ready(function() {
    let imagensDestaque = []; // Array para controlar qual imagem √© destaque
    let arquivosSelecionados = []; // Array para armazenar os arquivos
    let imagensParaRemover = []; // Array para armazenar IDs das imagens a serem removidas
    
    // Fun√ß√£o para processar arquivos
    function processarArquivos(files) {
        const previewContainer = $('#previewContainer');
        const previewList = $('#imagePreviewList');
        
        // Limpar preview anterior
        previewList.empty();
        imagensDestaque = [];
        arquivosSelecionados = Array.from(files);
        
        if (files.length > 0) {
            previewContainer.show();
            
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imageDiv = $(`
                            <div class="image-preview-item" data-index="${index}">
                                <img src="${e.target.result}" class="preview-image">
                                <div class="destaque-badge">DESTAQUE</div>
                                <div class="image-name">${file.name}</div>
                            </div>
                        `);
                        
                        previewList.append(imageDiv);
                        
                        // Marcar a primeira imagem como destaque por padr√£o se n√£o houver imagens existentes com destaque
                        const hasExistingDestaque = $('.existing-image-item .existing-preview-image.destaque').length > 0;
                        if (index === 0 && !hasExistingDestaque) {
                            imagensDestaque[index] = true;
                            imageDiv.find('.preview-image').addClass('destaque');
                            imageDiv.find('.destaque-badge').addClass('show');
                        } else {
                            imagensDestaque[index] = false;
                        }
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
        } else {
            previewContainer.hide();
        }
    }
    
    // Event listener para input file
    $('#imagensPacote').on('change', function(e) {
        processarArquivos(e.target.files);
    });
    
    // Drag and Drop functionality
    const uploadContainer = $('.image-upload-container');
    
    uploadContainer.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    uploadContainer.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    uploadContainer.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        
        const files = e.originalEvent.dataTransfer.files;
        const input = $('#imagensPacote')[0];
        input.files = files;
        processarArquivos(files);
    });
    
    // Evento para selecionar nova imagem como destaque
    $(document).on('click', '.image-preview-item', function() {
        const index = $(this).data('index');
        
        // Remover destaque de todas as imagens (existentes e novas)
        $('.image-preview-item, .existing-image-item').each(function() {
            $(this).find('.preview-image, .existing-preview-image').removeClass('destaque');
            $(this).find('.destaque-badge').removeClass('show');
            if ($(this).hasClass('image-preview-item')) {
                imagensDestaque[$(this).data('index')] = false;
            }
        });
        
        // Marcar a imagem clicada como destaque
        $(this).find('.preview-image').addClass('destaque');
        $(this).find('.destaque-badge').addClass('show');
        imagensDestaque[index] = true;
        
        console.log(`Nova imagem ${index} marcada como destaque. Array atual:`, imagensDestaque);
    });
    
    // Evento para selecionar imagem existente como destaque
    $(document).on('click', '.existing-image-item', function() {
        const imagemId = $(this).data('id');
        
        // Remover destaque de todas as imagens (existentes e novas)
        $('.image-preview-item, .existing-image-item').each(function() {
            $(this).find('.preview-image, .existing-preview-image').removeClass('destaque');
            $(this).find('.destaque-badge').removeClass('show');
            if ($(this).hasClass('image-preview-item')) {
                imagensDestaque[$(this).data('index')] = false;
            }
        });
        
        // Marcar a imagem existente clicada como destaque
        $(this).find('.existing-preview-image').addClass('destaque');
        $(this).find('.destaque-badge').addClass('show');
        
        console.log(`Imagem existente ${imagemId} marcada como destaque`);
    });
    
    // Evento para remover imagem existente
    $(document).on('click', '.remove-existing-btn', function(e) {
        e.stopPropagation(); // Evitar que o clique na imagem seja acionado
        const imagemId = $(this).data('id');
        const imageItem = $(this).closest('.existing-image-item');
        
        if (confirm('Tem certeza que deseja remover esta imagem?')) {
            imagensParaRemover.push(imagemId);
            imageItem.remove();
            console.log('Imagem marcada para remo√ß√£o:', imagemId);
        }
    });
    
    // Interceptar o submit do formul√°rio para incluir informa√ß√µes de destaque e remo√ß√£o
    $('.registration-form').on('submit', function(e) {
        // Debug: verificar arrays antes de enviar
        console.log('Array imagensDestaque antes do envio:', imagensDestaque);
        console.log('Array imagensParaRemover antes do envio:', imagensParaRemover);
        
        // Adicionar campos hidden com informa√ß√µes de destaque para novas imagens
        imagensDestaque.forEach((isDestaque, index) => {
            const valor = isDestaque ? 'true' : 'false';
            console.log(`Enviando imagemDestaque[${index}] = ${valor}`);
            
            $('<input>').attr({
                type: 'hidden',
                name: `imagemDestaque[${index}]`,
                value: valor
            }).appendTo(this);
        });
        
        // Adicionar campos hidden com IDs das imagens a serem removidas
        imagensParaRemover.forEach((imagemId, index) => {
            $('<input>').attr({
                type: 'hidden',
                name: `imagensParaRemover[${index}]`,
                value: imagemId
            }).appendTo(this);
        });
        
        // Verificar qual imagem existente est√° marcada como destaque
        const imagemExistenteDestaque = $('.existing-image-item .existing-preview-image.destaque').closest('.existing-image-item').data('id');
        if (imagemExistenteDestaque) {
            $('<input>').attr({
                type: 'hidden',
                name: 'imagemExistenteDestaque',
                value: imagemExistenteDestaque
            }).appendTo(this);
        }
    });
});
</script>

<style>
.image-preview-item:hover,
.existing-image-item:hover {
    transform: scale(1.05);
    transition: transform 0.2s ease;
}

.image-preview-item,
.existing-image-item {
    position: relative;
    transition: transform 0.2s ease;
}

.existing-preview-image {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #ddd;
    cursor: pointer;
}

.existing-preview-image.destaque {
    border-color: #007bff;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
}

.remove-existing-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-existing-btn:hover {
    background: #c82333;
}

#imagePreviewList,
#existingImagesList {
    max-height: 400px;
    overflow-y: auto;
}
</style>
</body>
</html>