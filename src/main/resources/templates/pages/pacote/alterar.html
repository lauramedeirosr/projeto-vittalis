<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="pt-br">
<head>
    <link rel="icon" type="imagem/png" th:href="@{/img/sub-logo1.png}">
    <link rel="stylesheet" th:href="@{/css/cadastro.css}"/>
    <link rel="stylesheet" th:href="@{/css/upload-imagens.css}"/>
    <th:block th:replace="fragments/config :: config"></th:block>
    <title>Formul√°rio de Cadastro de Pacotes</title>
</head>

<body>

<div th:replace="fragments/header :: header"></div>
<main>
    <h2 class="formulario d-flex justify-content-center mb-4">Formul√°rio de Cadastro de Pacotes</h2>
    <br>
    <div class="container mx-auto d-block">
        <form class="registration-form" th:action="@{/pacote/atualizar}" th:object="${pacote}" method="post" enctype="multipart/form-data" novalidate>
            <input type="hidden" th:field="*{id}"/>

            <!-- Nome Completo -->
            <div class="form-group row mb-4">
                <h3 class="dados">Dados do Pacote</h3>
                <br>
                <div class="col-sm-12">
                    <small class="nomeInput form-text text-muted d-block mt-1">Nome do Destino</small>
                    <input type="text" class="form-control" id="nomeDestino"
                           name="nomeDestino" placeholder="EX.: S√£o Paulo para Maldivas" required th:field="*{nomeDestino}">
                </div>
            </div>


            <div class="form-group row mb-4">
                <div class="col-sm-12">
                    <small class="nomeInput form-text text-muted d-block mt-1">Pre√ßo</small>
                    <input type="text"  class="form-control" id="preco" name="preco"
                           placeholder="$" required th:field="*{preco}">"/>
                </div>
            </div>

            <!-- N√∫mero de Telefone -->
            <div class="form-group row mb-4">
                <div class="col-sm-12">
                    <small class=" nomeInput form-text text-muted d-block mt-1">Descri√ß√£o do Pacote</small>
                    <textarea id="w3review" name="w3review" rows="2" cols="148" placeholder="Descri√ß√£o..." th:field="*{descricao}"></textarea>
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-md-6 mb-2 mb-md-0">
                    <small class=" nomeInput form-text text-muted d-block mt-1">Data limite da insci√ß√£o</small>
                    <input type="date"  class="form-control" id="data_limite" placeholder="dd/mm/aaaa" th:field="*{dataLimiteInscricao}" required/>
                </div>

                <div class="col-md-6">
                    <small class=" nomeInput form-text text-muted d-block mt-1">Data da Expedi√ß√£o</small>
                    <input type="date"  class="form-control" id="dataExpedicao" th:field="*{dataExpedicao}" placeholder="dd/mm/aaaa" required/>

                </div>
            </div>
            <br>

            <div class="row mb-2">
                <div class="col-md-12 mb-2 mb-md-0">
                    <small class="nomeInput form-text text-muted d-block mt-1">Imagens do Pacote</small>
                    <!-- Imagens j√° cadastradas -->
                    <div class="row mb-4" th:if="${imagens != null and #lists.size(imagens) > 0}">
                        <div class="col-md-12">
                            <h5>Imagens cadastradas:</h5>
                            <div id="existingImageList" class="d-flex flex-wrap gap-3">
                                <div class="existing-image-item image-preview-item" th:each="img : ${imagens}" th:attr="data-id=${img.id}">
                                    <img th:src="${img.URL}" class="preview-image" th:classappend="${img.destaque} ? ' destaque' : ''">
                                    <div class="destaque-badge" th:classappend="${img.destaque} ? ' show' : ''">DESTAQUE</div>
                                    <div class="image-name" th:text="${img.URL != null ? img.URL : ''}"></div>
                                    <div class="form-check mt-2">
                                        <input type="checkbox" class="form-check-input" th:value="${img.id}" name="imagensParaRemover" th:id="${'remove-' + img.id}">
                                        <label class="form-check-label" th:for="${'remove-' + img.id}">Remover</label>
                                    </div>
                                </div>
                            </div>
                            <small class="form-text text-muted mt-2">Clique em uma imagem cadastrada para marc√°-la como destaque</small>
                            <input type="hidden" id="imagemExistenteDestaque" name="imagemExistenteDestaque"
                                   th:value="${(imagens != null and !(imagens.?[destaque]).isEmpty()) ? (imagens.?[destaque])[0].id : null}">
                        </div>
                    </div>
                    <div class="image-upload-container">
                        <div class="upload-icon">üì∑</div>
                        <label for="imagensPacote" class="custom-file-upload">
                            Selecionar Imagens
                            <input type="file" id="imagensPacote" name="imagensPacote" multiple accept="image/*"/>
                        </label>
                        <div class="upload-instructions">
                            Arraste e solte as imagens aqui ou clique para selecionar<br>
                            <small>Formatos aceitos: JPG, PNG, GIF</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview das imagens selecionadas -->
            <div class="row mb-4" id="previewContainer" style="display: none;">
                <div class="col-md-12">
                    <h5>Imagens Selecionadas:</h5>
                    <div id="imagePreviewList" class="d-flex flex-wrap gap-3">
                        <!-- As imagens ser√£o inseridas aqui via JavaScript -->
                    </div>
                    <small class="form-text text-muted mt-2">Clique em uma imagem para marc√°-la como destaque</small>
                </div>
            </div>

            <br>
            <!-- Navios -->
            <h3 class="dados">Escolha do Navio</h3>
            <br>
            <div class="row mb-2">
                <!-- Coluna da esquerda -->
                <div class="col-md-6">
                    <!-- Campo Navio -->
                    <div class="mb-3">
                        <label for="navio" class="form-label">Navios</label>
                        <br>
                        <select id="navio"  class="form-select" name="lista_navio">
                            <option value="">Selecione o Navio</option>
                            <option
                                    th:each="navio : ${navios}"
                                    th:value="${navio.id}"
                                    th:text="${navio.nomeNavio}">
                            </option>
                        </select>
                        <label for="vagas" class="form-label">Vagas dispon√≠veis:</label>
                        <input id="vagas" type="text" placeholder="Vagas dispon√≠veis" class="form-control" th:field="*{vagasDisponiveis}">
                    </div>

                    <!-- Campo Vagas -->


                </div>

                <!-- Coluna da direita -->
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check1">
                                <label class="form-check-label" for="check1">Festas</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check2">
                                <label class="form-check-label" for="check2">Internet</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check3">
                                <label class="form-check-label" for="check3">Piscina</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check4">
                                <label class="form-check-label" for="check4">Academia</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check5">
                                <label class="form-check-label" for="check5">Spa</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check6">
                                <label class="form-check-label" for="check6">Sauna</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>







            <div class="form-group row mb-4">





                <div class="form-group row mt-4 col-sm-12">
                    <div class="divBotoes col-sm-12 d-flex justify-content-center">
                        <div class="text-center">
                            <button type="submit" class="botaoCadastrar">Salvar</button>
                        </div>
                        <div class="text-center">
                            <button type="reset" class="botaoCadastrar">Limpar</button>
                        </div>
                        <div class="text-center">
                            <button type="button" class="botaoCadastrar" onclick="window.location.href='/home'">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->

        </form>
    </div>
</main>

<div th:replace="fragments/footer :: footer"></div>


<!-- Adicione este script no final do body -->

<div th:replace="fragments/scripts :: scripts"></div>

<script>
    $(document).ready(function() {
        let imagensDestaque = []; // Array para controlar qual imagem √© destaque
        let arquivosSelecionados = []; // Array para armazenar os arquivos

        // Fun√ß√£o para processar arquivos
        function processarArquivos(files) {
            const previewContainer = $('#previewContainer');
            const previewList = $('#imagePreviewList');

            // Limpar preview anterior
            previewList.empty();
            imagensDestaque = [];
            arquivosSelecionados = Array.from(files);

            if (files.length > 0) {
                previewContainer.show();

                Array.from(files).forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();

                        reader.onload = function(e) {
                            const imageDiv = $(`
                            <div class="image-preview-item" data-index="${index}">
                                <img src="${e.target.result}" class="preview-image">
                                <div class="destaque-badge">DESTAQUE</div>
                                <div class="image-name">${file.name}</div>
                            </div>
                        `);

                            previewList.append(imageDiv);

                            // Marcar a primeira imagem como destaque por padr√£o
                            if (index === 0) {
                                imagensDestaque[index] = true;
                                imageDiv.find('.preview-image').addClass('destaque');
                                imageDiv.find('.destaque-badge').addClass('show');
                            } else {
                                imagensDestaque[index] = false;
                            }
                        };

                        reader.readAsDataURL(file);
                    }
                });
            } else {
                previewContainer.hide();
            }
        }

        // Event listener para input file
        $('#imagensPacote').on('change', function(e) {
            processarArquivos(e.target.files);
        });

        // Drag and Drop functionality
        const uploadContainer = $('.image-upload-container');

        uploadContainer.on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });

        uploadContainer.on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });

        uploadContainer.on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');

            const files = e.originalEvent.dataTransfer.files;
            const input = $('#imagensPacote')[0];
            input.files = files;
            processarArquivos(files);
        });

        // Evento para selecionar imagem NOVA como destaque (upload)
        $(document).on('click', '.image-preview-item:not(.existing-image-item)', function() {
            const index = $(this).data('index');

            // Remover destaque de todas as imagens
            $('#imagePreviewList .image-preview-item').each(function() {
                $(this).find('.preview-image').removeClass('destaque');
                $(this).find('.destaque-badge').removeClass('show');
                imagensDestaque[$(this).data('index')] = false;
            });

            // Marcar a imagem clicada como destaque
            $(this).find('.preview-image').addClass('destaque');
            $(this).find('.destaque-badge').addClass('show');
            imagensDestaque[index] = true;
            console.log(`Imagem nova ${index} marcada como destaque. Array atual:`, imagensDestaque);
        });

        // Evento para selecionar imagem EXISTENTE como destaque
        $(document).on('click', '.existing-image-item', function() {
            // Remover destaque de todas as imagens existentes
            $('.existing-image-item').each(function() {
                $(this).find('.preview-image').removeClass('destaque');
                $(this).find('.destaque-badge').removeClass('show');
            });

            // Marcar a imagem clicada como destaque
            $(this).find('.preview-image').addClass('destaque');
            $(this).find('.destaque-badge').addClass('show');

            // Setar hidden com ID da imagem existente destaque
            const id = $(this).data('id');
            $('#imagemExistenteDestaque').val(id);
            console.log('Imagem existente destaque definida para ID:', id);
        });

        // Interceptar o submit do formul√°rio para incluir informa√ß√µes de destaque
        $('.registration-form').on('submit', function(e) {
            // Antes de enviar, garantir que campos hidden de destaque das novas imagens sejam criados
            const form = this;
            // Remover quaisquer hidden antigos para evitar duplicidade
            $(form).find('input[name="imagemDestaque"]').remove();

            imagensDestaque.forEach((isDestaque) => {
                $('<input>').attr({
                    type: 'hidden',
                    name: 'imagemDestaque',
                    value: isDestaque ? 'true' : 'false'
                }).appendTo(form);
            });

            console.log('Array imagensDestaque antes do envio:', imagensDestaque);
        });
    });
</script>

<style>
    .image-preview-item:hover {
        transform: scale(1.05);
        transition: transform 0.2s ease;
    }

    .image-preview-item {
        transition: transform 0.2s ease;
    }

    #imagePreviewList {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
</body>
</html>